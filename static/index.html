<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Test of websocket</title>
      <style type="text/css">
          pre {
              margin: 0;
              font-family: monaco, "Courier New", Courier, monospace;
              line-height: 1.3;

              color: beige;
          }
          body {
              background: black;
          }
      </style>
      <style>
          #output * {
              /* don't allow the children of the scrollable element to be selected as an anchor node */
              overflow-anchor: none;
          }

          #anchor {
              /* allow the final child to be selected as an anchor node */
              overflow-anchor: auto;

              /* anchor nodes are required to have non-zero area */
              height: 1px;
          }

      </style>
  </head>
  <body>
    <script src="static/script/ansi_up/ansi_up.js" type="text/javascript"></script>
    <script>
        function start_scroll_down() {
            scroll = setInterval(function(){ window.scrollBy(0, 1000); console.log('start');}, 1500);
        }

        function stop_scroll_down() {
            clearInterval(scroll);
            console.log('stop');
        }
    </script>

    <script type="text/javascript">
        let socket = new WebSocket("ws://127.0.0.1:8085/runsh/env");
        console.log("Attempting Connection...");
        let ansi_up = new AnsiUp;
        let last = null
        function writeToScreen(message){
          let output = document.getElementById("output");
          let anchor = document.getElementById("anchor")
         let pre = document.createElement("pre");
          pre.style.wordWrap = "break-word";
          let msg = ansi_up.ansi_to_html(message)
          if (message.includes('\r')) {

            console.log("Rewriting: " + last.innerHTML)
            console.log("with: " + msg)
            last.innerHTML = msg

          } else {
            pre.innerHTML =msg ;
            last = pre
            // output.appendChild(pre);
            console.log("New line: " + msg)
            output.insertBefore(pre, anchor)
            window.scrollTo(0, output.scrollHeight)
          }
        }

        socket.onopen = () => {
            console.log("Successfully Connected");
            socket.send("Hi From the Client!")
        };
        socket.onmessage = msg => {
          //console.log(msg.data)
          writeToScreen(msg.data)
        }
        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
            socket.send("Client Closed!")
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

    </script>
    <div id="output">
        <div id="anchor"></div>
    </div>
  </body>
</html>

